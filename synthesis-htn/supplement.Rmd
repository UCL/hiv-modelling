---
title: "SEARCH Hypertension Modelling with HIV Synthesis"
author: "Matt Hickey"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  word_document:
always_allow_html: true

---

```{r setup, include=FALSE}

library(tidyverse)
library(readxl)
library(knitr)
library(kableExtra)

options(tinytex.verbose = TRUE)
options(scipen = 999)


knitr::opts_chunk$set(echo = FALSE, fig.height=10, fig.width=15)
knitr::opts_knit$set(root.dir = '~/Library/CloudStorage/Box-Box/1.sapphire_modelling/calibration')

pct <- function(x) {
  y <- paste0(round((x*100),0),"%")
  return(y)
}

load("SynthesisHTN.RData")

```



# Comparison of model output in 2015 to data from the literature
Based on `r nrow(df_sas_wide)/3` model runs

## Definitions
SOC = Standard of Care (Synthesis model output)   
GBD = Global Burden of Disease data

## Data Sources
Hypertension prevalence, diagnosis, treatment, and control using STEPS survey data from 15 countries in sub-Saharan Africa (2005-2015; Geldsetzer Lancet 2019)

Systolic blood pressure for men and women based on 2015 Global Burden of Disease survey data as published in Forouzanfar MH, Liu P, Roth GA, et al. Global Burden of Hypertension and Systolic Blood Pressure of at Least 110 to 115 mm Hg, 1990-2015. JAMA. 2017;317(2):165-182. doi:10.1001/jama.2016.19043


## SBP Increase with Age

```{r graph_sbp_w}
df_sbp %>% filter(sex == "Female", source %in% c("GBD 2015", "SOC"), year == "15") %>% 
    ggplot(aes(age,sbp, color=source)) +
    geom_boxplot() +
    theme_minimal(base_size = 14) +
    coord_cartesian(ylim = c(110,160)) +
    labs(x = "Age", y = "Mean SBP", title = "Mean SBP by age (Women)", subtitle = "in 2015") +
    theme(
      plot.title = element_text(size = 18, face = "bold"),
      axis.title.y = element_text(size = 16),
      axis.title.x = element_text(size = 16),
      legend.position = "bottom"
      )
#ggsave(paste0("05sbp_w_", Sys.Date(),".pdf"), path = "plots/", width = 10.65, height = 7.68, units = "in")
```

```{r graph_sbp_m}
 df_sbp %>% filter(sex == "Male", source %in% c("GBD 2015", "SOC"), year == "15") %>% 
    ggplot(aes(age,sbp, color=source)) +
    geom_boxplot() +
    theme_minimal(base_size = 14) +
    coord_cartesian(ylim = c(110,160)) +
    labs(x = "Age", y = "Mean SBP", title = "Mean SBP by age (Men)", subtitle = "in 2015") +
    theme(
      plot.title = element_text(size = 18, face = "bold"),
      axis.title.y = element_text(size = 16),
      axis.title.x = element_text(size = 16),
      legend.position = "bottom"
    )

  
  #ggsave(paste0("06sbp_m_", Sys.Date(),".pdf"), path = "plots/", width = 10.65, height = 7.68, units = "in")
```

## Hypertension Prevalence
Hypertension defined as true SBP >=140 mmHg, regardless of whether measured.

```{r graph_htn}

df_htn %>% filter(age %in% c("25-34", "35-44", "45-54", "55-64", "65+"), source %in% c("Geldsetzer", "SOC"), year == "15") %>% 
  ggplot(aes(age,htn, color=source)) +
    geom_boxplot() +
    theme_minimal(base_size = 14) +
    labs(x = "Age", y = "Proportion with hypertension", title = "Hypertension prevalence", subtitle = "in 2015") +
    coord_cartesian(ylim = c(0,NA)) +
    theme(plot.title = element_text(size = 18, face = "bold"),
      legend.position = "bottom")

df_sevhtn %>% filter(age != "18+", source %in% c("SEARCH (Kenya/Uganda)", "NIDS (South Africa)", "SOC"), year == "15") %>% 
  ggplot(aes(age, sevhtn, color=source)) +
    geom_boxplot() +
    theme_minimal(base_size = 14) +
    labs(x = "Age", y = "Proportion with severe hypertension (SBP ≥160)", title = "Severe hypertension prevalence", subtitle = "In 2015") +
    coord_cartesian(ylim = c(0,NA)) +
    theme(plot.title = element_text(size = 18, face = "bold"),
      legend.position = "bottom")

  #ggsave(paste0("01htn_", Sys.Date(),".pdf"), path = "plots/", width = 10.65, height = 7.68, units = "in")
```


## Hypertension Diagnosis 
* Measured SBP value if measured: true SBP + random error with SD 10 mmHg

* Hypertension diagnosis made if any of the following:
  1. measured SBP >=140 mmHg on two consecutive clinic visits
  2. measured SBP >=160 mmHg once
  3. started on antihypertensive medication (see Hypertension Treatment section below)

```{r graph_dx}
df_dx %>% filter(age %in% c("25-34", "35-44", "45-54", "55-64", "65+"), source %in% c("Geldsetzer", "SOC"), year == "15") %>% 
  ggplot(aes(age,dx, color=source)) +
    geom_boxplot() +
    theme_minimal(base_size = 14) +
    coord_cartesian(ylim = c(0,NA)) +
    labs(x = "Age", y = "Proportion diagnosed", title = "Hypertension diagnosis", subtitle = "in 2015") +
    theme(plot.title = element_text(size = 18, face = "bold"),
      legend.position = "bottom")

  #ggsave(paste0("02dx_", Sys.Date(),".pdf"), path = "plots/", width = 10.65, height = 7.68, units = "in")
```


## Hypertension Treatment

Defined as currently taking antihypertensive medications.
```{r graph_tx_curr}
df_tx_current %>% filter(age %in% c("25-34", "35-44", "45-54", "55-64", "65+", "18+", "All"), source %in% c("Geldsetzer", "SOC"), year == "15") %>% 
  ggplot(aes(age,tx, color=source)) +
    geom_boxplot() +
    theme_minimal(base_size = 14) +
    coord_cartesian(ylim = c(0,NA)) +
    labs(x = "Age", y = "Proportion currently on treatment", title = "Current hypertension treatment", subtitle = "in 2015") +
    theme(plot.title = element_text(size = 18, face = "bold"),
      legend.position = "bottom")

  #ggsave(paste0("03tx_", Sys.Date(),".pdf"), path = "plots/", width = 10.65, height = 7.68, units = "in")
```

<span style="color: blue;"> **Note:** The model considers treatment to be on medications and adherent to those medications. Real-world data is based on self-report of treatment and may include some who report taking medications but are non-adherent. </span>

Geldsetzer Lancet 2019 includes country-specific data on `r df_ssa_txctrl %>% nrow()` countries in SSA with data on medication treatment and reports an overall prevalence of pharmacologic hypertension treatment of 13.0% (95% CI 12.0-14.2%) when weighting countries by population size.

```{r htn_tx_data}
df_ssa_txctrl %>% select(country, tx, tx_95ci) %>% arrange(tx) %>% mutate(tx = pct(tx)) %>% kable(booktabs = T) %>% kable_styling(font_size = 12, bootstrap_options = c("striped", "hover", "condensed"), position = "center", full_width = FALSE)
```

Proportion on treatment in SSA from other literature:  

* 18% (2005; Ataklte Hypertens 2015)
* 8% (2015; Kenya STEPS)

Defined as ever taking antihypertensive medications.
```{r graph_tx_ever}
 df_tx_ever %>% filter(source %in% c("Geldsetzer", "SOC"), year == "15") %>% ggplot(aes(age,tx, color=source)) +
    geom_boxplot() +
    theme_minimal(base_size = 14) +
    coord_cartesian(ylim = c(0,NA)) +
    labs(x = "Age", y = "Proportion ever on treatment", title = "Ever on hypertension treatment", subtitle = "in 2015") +
    theme(plot.title = element_text(size = 18, face = "bold"),
      legend.position = "bottom")

  #ggsave(paste0("03tx_", Sys.Date(),".pdf"), path = "plots/", width = 10.65, height = 7.68, units = "in")
```


## Hypertension Control

* Control defined as current true SBP <140 among persons with maximum SBP >=140 (pre-treatment)

```{r graph_ctrl}
 df_ctrl %>% filter(age %in% c("25-34", "35-44", "45-54", "55-64", "65+", "18+", "All"), source %in% c("Geldsetzer", "SOC"), year == "15") %>% 
  ggplot(aes(age,control, color=source)) +
    geom_boxplot() +
    theme_minimal(base_size = 14) +
    coord_cartesian(ylim = c(0,NA)) +
    labs(x = "Age", y = "Proportion with controlled BP", title = "Hypertension control", subtitle = "in 2015") +
    theme(plot.title = element_text(size = 18, face = "bold"),
      legend.position = "bottom")

  #ggsave(paste0("04ctrl_", Sys.Date(),".pdf"), path = "plots/", width = 10.65, height = 7.68, units = "in")
```

Geldsetzer Lancet 2019 includes country-specific data on `r df_ssa_txctrl %>% nrow()` countries in SSA with data on hypertension control and reports an overall prevalence of hypertension control (<140/90 mmHg) of 4.3% (95% CI 3.6- 4.9%). 

```{r htn_ctrl_data}
df_ssa_txctrl %>% select(country, control, control_95ci) %>% arrange(control) %>% mutate(control = pct(control)) %>% kable(booktabs = T) %>% kable_styling(font_size = 12, bootstrap_options = c("striped", "hover", "condensed"), position = "center", full_width = FALSE)
```

Proportion with controlled hypertension in SSA from other literature:

* 7% (Ataklte Hypertens 2015)
* 3% (Kenya STEPS)

## CVD Events

**Data source:** 
Global Burden of Disease Collaborative Network.
Global Burden of Disease Study 2019 (GBD 2019) Results.
Seattle, United States: Institute for Health Metrics and Evaluation (IHME), 2020.
Available from https://vizhub.healthdata.org/gbd-results/.

### Incidence of Ischemic Heart Disease (moderate/severe events only)

Incidence of ischemic heart disease (angina and myocardial infarction(MI)) based on Global Burden of Disease data, assuming that angina/silent MI are under-ascertained, thus we compare incidence only of moderate/severe MI to available incidence data.

```{r}
df_cvd_inc %>% filter(cause == "Ischemic heart disease", sex == "Male") %>% 
  ggplot(aes(x = age, y = value, color = region)) +
  geom_boxplot() +
  theme_minimal(base_size = 14) +
    labs(title = "Incidence of Ischemic Heart Disease per 100 person-years in 2019 (GBD) 2015 (Synthesis)",
         subtitle = "Men",
         y = "Incident ischemic heart disease per 100 person-years", x = "Age") +
    theme(
      plot.title = element_text(size = 18, face = "bold"),
      axis.title.y = element_text(size = 16),
      axis.title.x = element_text(size = 16),
      legend.position = "bottom"
    )

df_cvd_inc %>% filter(cause == "Ischemic heart disease", sex == "Female") %>% 
  ggplot(aes(x = age, y = value, color = region)) +
  geom_boxplot() +
  theme_minimal(base_size = 14) +
    labs(title = "Incidence of Ischemic Heart Disease per 100 person-years in 2019 (GBD) 2015 (Synthesis)",
         subtitle = "Women",
         y = "Incident ischemic heart disease per 100 person-years", x = "Age") +
    theme(
      plot.title = element_text(size = 18, face = "bold"),
      axis.title.y = element_text(size = 16),
      axis.title.x = element_text(size = 16),
      legend.position = "bottom"
    )

df_cvd_inc %>% filter(cause == "Ischemic heart disease", sex !="Both") %>% group_by(source, sex, age) %>% summarize("Incidence"= round(mean(value),2), min = round(min(value),2), Q1 = round(quantile(value,0.25),2), median = round(median(value),2), Q3 = round(quantile(value, 0.75),2), max = round(max(value),2)) %>% kable(booktabs = T, align = "lcccccc") %>% kable_styling(font_size = 12, bootstrap_options = c("striped", "hover", "condensed"), position = "center", full_width = FALSE)
  
```


### Prevalence of Ischemic Heart Disease
```{r}

df_cvd_prev %>% filter(sex == "Male", cause == "Ischemic heart disease") %>%
  ggplot(aes(x = age, y = value, color = region)) +
  geom_boxplot() +
  theme_minimal(base_size = 14) +
    labs(title = "Prevalence of Ischemic Heart Disease per 100 person-years in 2015 (Synthesis)",
         subtitle = "Men",
         y = "Prevalent ischemic heart disease per 100 person-years", x = "Age") +
    theme(
      plot.title = element_text(size = 18, face = "bold"),
      axis.title.y = element_text(size = 16),
      axis.title.x = element_text(size = 16),
      legend.position = "bottom"
    )

df_cvd_prev %>% filter(sex == "Female", cause == "Ischemic heart disease") %>%
  ggplot(aes(x = age, y = value, color = region)) +
  geom_boxplot() +
  theme_minimal(base_size = 14) +
    labs(title = "Prevalence of Ischemic Heart Disease per 100 person-years in 2015 (Synthesis)",
         subtitle = "Women",
         y = "Prevalent ischemic heart disease per 100 person-years", x = "Age") +
    theme(
      plot.title = element_text(size = 18, face = "bold"),
      axis.title.y = element_text(size = 16),
      axis.title.x = element_text(size = 16),
      legend.position = "bottom"
    )
  
```

### Incidence of Stroke

Incidence of stroke based on Global Burden of Disease data, assuming that mild strokes under-ascertained, thus we compare incidence only of moderate/severe stroke to available incidence data.

#### Any Stroke (moderate/severe only)
```{r}
df_cvd_inc %>% filter(sex == "Male", cause == "Stroke") %>% 
  ggplot(aes(x = age, y = value, color = region)) +
  geom_boxplot() +
  theme_minimal(base_size = 14) +
    labs(title = "Incidence of Stroke per 100 person-years in 2019 (GBD) 2015 (Synthesis)",
         subtitle = "Men",
         y = "Incident stroke per 100 person-years", x = "Age") +
    theme(
      plot.title = element_text(size = 18, face = "bold"),
      axis.title.y = element_text(size = 16),
      axis.title.x = element_text(size = 16),
      legend.position = "bottom"
    )

df_cvd_inc %>% filter(sex == "Female", cause == "Stroke") %>% 
  ggplot(aes(x = age, y = value, color = region)) +
  geom_boxplot() +
  theme_minimal(base_size = 14) +
    labs(title = "Incidence of Stroke per 100 person-years in 2019 (GBD) 2015 (Synthesis)",
         subtitle = "Women",
         y = "Incident stroke per 100 person-years", x = "Age") +
    theme(
      plot.title = element_text(size = 18, face = "bold"),
      axis.title.y = element_text(size = 16),
      axis.title.x = element_text(size = 16),
      legend.position = "bottom"
    )

df_cvd_inc %>% filter(cause == "Stroke", sex !="Both") %>% group_by(source, sex, age) %>% summarize("Incidence"= round(mean(value),2), min = round(min(value),2), Q1 = round(quantile(value,0.25),2), median = round(median(value),2), Q3 = round(quantile(value, 0.75),2), max = round(max(value),2)) %>% kable(booktabs = T, align = "lcccccc") %>% kable_styling(font_size = 12, bootstrap_options = c("striped", "hover", "condensed"), position = "center", full_width = FALSE)
  
```


### Prevalence of Stroke
Defined as any prior history of stroke among living adults.

```{r}
df_cvd_prev %>% filter(sex == "Male", cause == "Stroke") %>% 
  ggplot(aes(x = age, y = value, color = region)) +
  geom_boxplot() +
  theme_minimal(base_size = 14) +
    labs(title = "Prevalence of Stroke per 100 person-years in 2019 (GBD) 2015 (Synthesis)",
         subtitle = "Men",
         y = "Prevalent stroke per 100 person-years", x = "Age") +
    theme(
      plot.title = element_text(size = 18, face = "bold"),
      axis.title.y = element_text(size = 16),
      axis.title.x = element_text(size = 16),
      legend.position = "bottom"
    )

df_cvd_prev %>% filter(sex == "Female") %>% 
  ggplot(aes(x = age, y = value, color = region)) +
  geom_boxplot() +
  theme_minimal(base_size = 14) +
    labs(title = "Prevalence of Stroke per 100 person-years in 2019 (GBD) 2015 (Synthesis)",
         subtitle = "Women",
         y = "Prevalent stroke per 100 person-years", x = "Age") +
    theme(
      plot.title = element_text(size = 18, face = "bold"),
      axis.title.y = element_text(size = 16),
      axis.title.x = element_text(size = 16),
      legend.position = "bottom"
    )

# df_ihme_sas_cvd_prev %>% filter(cause == "Stroke", sex !="Both") %>% group_by(source, sex, age) %>% summarize("Prevalence"= round(mean(value),3), min = round(min(value),3), Q1 = round(quantile(value,0.25),3), median = round(median(value),3), Q3 = round(quantile(value, 0.75),3), max = round(max(value),3)) %>% kable(booktabs = T, align = "lcccccc") %>% kable_styling(font_size = 12, bootstrap_options = c("striped", "hover", "condensed"), position = "center", full_width = FALSE)
  
```


## CVD Mortality
Mortality resulting from ischemic heart disease or stroke.

```{r}
df_cvd_death %>% filter(sex == "Male") %>% 
  ggplot(aes(x = age, y = cvd_death_rate, color = source)) +
  geom_boxplot() +
  theme_minimal(base_size = 14) +
    labs(title = "CVD Mortality Rate per 100 person-years in 2019 (GBD) and 2015 (Synthesis)",
         subtitle = "Men",
         y = "CVD mortality per 100 person-years", x = "Age") +
    theme(
      plot.title = element_text(size = 18, face = "bold"),
      axis.title.y = element_text(size = 16),
      axis.title.x = element_text(size = 16),
      legend.position = "bottom"
    )

df_cvd_death %>% filter(sex == "Female") %>% 
  ggplot(aes(x = age, y = cvd_death_rate, color = source)) +
  geom_boxplot() +
  theme_minimal(base_size = 14) +
    labs(title = "CVD Mortality Rate per 100 person-years in 2019 (GBD) and 2015 (Synthesis)",
         subtitle = "Women",
         y = "CVD mortality per 100 person-years", x = "Age") +
    theme(
      plot.title = element_text(size = 18, face = "bold"),
      axis.title.y = element_text(size = 16),
      axis.title.x = element_text(size = 16),
      legend.position = "bottom"
    )

df_cvd_death %>% filter(age %in% c("18+", "20+")) %>% 
  ggplot(aes(x = age, y = cvd_death_rate, color = source)) +
  geom_boxplot() +
  theme_minimal(base_size = 14) +
    labs(title = "CVD Mortality Rate per 100 person-years in 2019 (GBD) and 2015 (Synthesis)",
         subtitle = "Men and Women",
         y = "CVD mortality per 100 person-years", x = "Age") +
    theme(
      plot.title = element_text(size = 18, face = "bold"),
      axis.title.y = element_text(size = 16),
      axis.title.x = element_text(size = 16),
      legend.position = "bottom"
    )

x <- df_cvd_death %>% filter(sex !="Both") %>% group_by(source, sex, age) %>% summarize("Mortality rate"= round(mean(cvd_death_rate),3), min = round(min(cvd_death_rate),3), Q1 = round(quantile(cvd_death_rate,0.25),3), median = round(median(cvd_death_rate),3), Q3 = round(quantile(cvd_death_rate, 0.75),3), max = round(max(cvd_death_rate),3))
write_csv(x, "mortality_comparison.csv")
x %>% kable(booktabs = T, align = "lcccccc") %>% kable_styling(font_size = 12, bootstrap_options = c("striped", "hover", "condensed"), position = "center", full_width = FALSE)
  
```


# Intervention Scenarios (2023 - 2073)
**Hypertension care cascade for intervention packages compared to standard of care**  


## Prevalence
```{r graph_htn_int}

df_sas %>% filter(var == "p_htn_true", age %in% c("18+", "25-34", "35-44", "45-54", "55-64", "65+"), year == "2373", sex == "All") %>% 
  ggplot(aes(age, value, color=source)) +
    geom_boxplot() +
    theme_minimal(base_size = 14) +
    labs(x = "Age", y = "Proportion with hypertension", title = "Hypertension prevalence", subtitle = "Average from 2023 - 2073") +
    coord_cartesian(ylim = c(0,NA)) +
    theme(plot.title = element_text(size = 18, face = "bold"),
      legend.position = "bottom")

df_sas %>% filter(var == "p_htn_true160", year == "2373", sex == "All") %>% 
  ggplot(aes(age, value, color=source)) +
    geom_boxplot() +
    theme_minimal(base_size = 14) +
    labs(x = "Age", y = "Proportion with severe hypertension (SBP ≥160)", title = "Severe hypertension prevalence", subtitle = "Average from 2023 - 2073, max SBP (regardless of current BP control)") +
    coord_cartesian(ylim = c(0,NA)) +
    theme(plot.title = element_text(size = 18, face = "bold"),
      legend.position = "bottom")

  #ggsave(paste0("01htn_", Sys.Date(),".pdf"), path = "plots/", width = 10.65, height = 7.68, units = "in")
```

## Diagnosis
```{r graph_dx_int}
df_sas %>% filter(var == "p_diagnosed_hypert", age %in% c("25-34", "35-44", "45-54", "55-64", "65+"), year == "2373", sex == "All") %>% 
  ggplot(aes(age,value, color=source)) +
    geom_boxplot() +
    theme_minimal(base_size = 14) +
    coord_cartesian(ylim = c(0,NA)) +
    labs(x = "Age", y = "Proportion diagnosed", title = "Hypertension diagnosis", subtitle = "Average from 2023 - 2073") +
    theme(plot.title = element_text(size = 18, face = "bold"),
      legend.position = "bottom")

df_sas %>% filter(var == "p_dx_htn_true160", year == "2373", sex == "All") %>% 
  ggplot(aes(age,value, color=source)) +
    geom_boxplot() +
    theme_minimal(base_size = 14) +
    coord_cartesian(ylim = c(0,NA)) +
    labs(x = "Age", y = "Proportion diagnosed", title = "Hypertension diagnosis among those with severe hypertension", subtitle = "Average from 2023 - 2073") +
    theme(plot.title = element_text(size = 18, face = "bold"),
      legend.position = "bottom")

  #ggsave(paste0("02dx_", Sys.Date(),".pdf"), path = "plots/", width = 10.65, height = 7.68, units = "in")
```

**Note:** Diagnosis can be >100% because the denominator is the proportion with true hypertension (SBP >=140) and the numerator is all with diagnosed hypertension including those who were overdiagnosed (measured BP >=140 but true BP <140). See additional graphs for overdiagnosis below.

## Overdiagnosis

```{r graph_dx_over}
df_sas %>% filter(var == "p_dx_htn_over", year == "2373", sex == "All") %>%
  ggplot(aes(age, value, color=source)) +
    geom_boxplot() +
    theme_minimal(base_size = 14) +
    coord_cartesian(ylim = c(0,NA)) +
    labs(x = "Age", y = "Proportion overdiagnosed", title = "Overdiagnosis", subtitle = "Proportion of normotensive individuals (true SBP <140) who received a hypertension diagnosis") +
    theme(plot.title = element_text(size = 18, face = "bold"),
      legend.position = "bottom")

```

```{r graph_dx_true}
df_sas %>% filter(var == "p_dx_htn_true", year == "2373", sex == "All") %>%
  ggplot(aes(age, value, color=source)) +
    geom_boxplot() +
    theme_minimal(base_size = 14) +
    coord_cartesian(ylim = c(0,NA)) +
    labs(x = "Age", y = "Proportion with true SBP >=140 who were diagnosed", title = "True diagnosis (Average from 2023 - 2073)", subtitle = "Proportion with of those with true SBP >=140 who were diagnosed with hypertension") +
    theme(plot.title = element_text(size = 18, face = "bold"),
      legend.position = "bottom")

```


## Treatment
```{r graph_tx_curr_int}
df_sas %>% filter(var == "p_on_tx_htn", age %in% c("25-34", "35-44", "45-54", "55-64", "65+"), year == "2373", sex == "All") %>%
  ggplot(aes(age,value, color=source)) +
    geom_boxplot() +
    theme_minimal(base_size = 14) +
    coord_cartesian(ylim = c(0,NA)) +
    labs(x = "Age", y = "Proportion currently on treatment", title = "Hypertension treatment (current) among those with true hypertension", subtitle = "Average from 2023 - 2073") +
    theme(plot.title = element_text(size = 18, face = "bold"),
      legend.position = "bottom")

df_sas %>% filter(var == "p_on_tx_htn160", year == "2373", sex == "All") %>%
  ggplot(aes(age,value, color=source)) +
    geom_boxplot() +
    theme_minimal(base_size = 14) +
    coord_cartesian(ylim = c(0,NA)) +
    labs(x = "Age", y = "Proportion currently on treatment", title = "Hypertension treatment (current) among those with severe hypertension", subtitle = "Average from 2023 - 2073") +
    theme(plot.title = element_text(size = 18, face = "bold"),
      legend.position = "bottom")

```

```{r graph_tx_ever_int}
df_sas %>% filter(var == "p_ever_tx_htn", age %in% c("18+", "25-44", "45-64", "65+"), year == "2373", sex == "All") %>%
  ggplot(aes(age,value, color=source)) +
    geom_boxplot() +
    theme_minimal(base_size = 14) +
    coord_cartesian(ylim = c(0,NA)) +
    labs(x = "Age", y = "Proportion ever on treatment", title = "Hypertension treatment (ever) among those with a true hypertension diagnosis", subtitle = "Average from 2023 - 2073") +
    theme(plot.title = element_text(size = 18, face = "bold"),
      legend.position = "bottom")

```

### Overtreatment
```{r}
df_sas %>% filter(var == "p_on_tx_htn_over", year == "2373", sex == "All") %>%
  ggplot(aes(age,value, color=source)) +
    geom_boxplot() +
    theme_minimal(base_size = 14) +
    coord_cartesian(ylim = c(0,NA)) +
    labs(x = "Age", y = "Proportion currently on treatment", title = "Hypertension treatment (current) among those who do not have hypertension (max SBP <140)", subtitle = "Average from 2023 - 2073") +
    theme(plot.title = element_text(size = 18, face = "bold"),
      legend.position = "bottom")
```


## HTN control
```{r graph_ctrl_int}
df_sas %>% filter(var == "p_hypert_control", age %in% c("25-34", "35-44", "45-54", "55-64", "65+"), year == "2373", sex == "All") %>%
  ggplot(aes(age,value, color=source)) +
    geom_boxplot() +
    theme_minimal(base_size = 14) +
    coord_cartesian(ylim = c(0,NA)) +
    labs(x = "Age", y = "Proportion with controlled BP", title = "Hypertension control", subtitle = "Average from 2023 - 2073") +
    theme(plot.title = element_text(size = 18, face = "bold"),
      legend.position = "bottom")

df_sas %>% filter(var == "p_hypert_control160", year == "2373", sex == "All") %>%
  ggplot(aes(age,value, color=source)) +
    geom_boxplot() +
    theme_minimal(base_size = 14) +
    coord_cartesian(ylim = c(0,NA)) +
    labs(x = "Age", y = "Proportion with controlled BP", title = "Hypertension control among those with severe hypertension (SBP ≥160)", subtitle = "Average from 2023 - 2073") +
    theme(plot.title = element_text(size = 18, face = "bold"),
      legend.position = "bottom")

```

## SBP Increase with Age
```{r graph_sbp_int}
df_sas %>% filter(var == "m_sbp", year == "2373", sex == "Female") %>%
  ggplot(aes(age,value, color=source)) +
    geom_boxplot() +
    theme_minimal(base_size = 14) +
    coord_cartesian(ylim = c(110,160)) +
    labs(x = "Age", y = "Mean SBP", title = "Mean SBP by age (Women)", subtitle = "Average from 2023 - 2073") +
    theme(
      plot.title = element_text(size = 18, face = "bold"),
      axis.title.y = element_text(size = 16),
      axis.title.x = element_text(size = 16),
      legend.position = "bottom"
      )
```

```{r graph_sbp_m_int}
df_sas %>% filter(var == "m_sbp", year == "2373", sex == "Male") %>%
  ggplot(aes(age,value, color=source)) +
      geom_boxplot() +
      theme_minimal(base_size = 14) +
      coord_cartesian(ylim = c(110,160)) +
      labs(x = "Age", y = "Mean SBP", title = "Mean SBP by age (Men)", subtitle = "Average from 2023 - 2073") +
      theme(
        plot.title = element_text(size = 18, face = "bold"),
        axis.title.y = element_text(size = 16),
        axis.title.x = element_text(size = 16),
        legend.position = "bottom"
    )

```

## CVD Event incidence

#### Incident Ischemic Heart Disease Events (moderate/severe events only)
```{r}
df_sas %>% filter(var == "rate_ihd_modsev", year == "2373", sex == "Male", age != "All") %>% 
  ggplot(aes(x = age, y = value, color = source)) +
  geom_boxplot() +
  theme_minimal(base_size = 14) +
    labs(title = "Average Annual Incidence of Ischemic Heart Disease per 100 person-years from 2023-2073",
         subtitle = "Men",
         y = "Incident ischemic heart disease per 100 person-years", x = "Age") +
    theme(
      plot.title = element_text(size = 18, face = "bold"),
      axis.title.y = element_text(size = 16),
      axis.title.x = element_text(size = 16),
      legend.position = "bottom"
    )

df_sas %>% filter(var == "rate_ihd_modsev", year == "2373", sex == "Female", age != "All") %>% 
  ggplot(aes(x = age, y = value, color = source)) +
  geom_boxplot() +
  theme_minimal(base_size = 14) +
    labs(title = "Average Annual Incidence of Ischemic Heart Disease per 100 person-years from 2023-2073",
         subtitle = "Women",
         y = "Incident ischemic heart disease per 100 person-years", x = "Age") +
    theme(
      plot.title = element_text(size = 18, face = "bold"),
      axis.title.y = element_text(size = 16),
      axis.title.x = element_text(size = 16),
      legend.position = "bottom"
    )

df_sas %>% filter(var == "n_ihd_diff", year == "2373") %>% 
  ggplot(aes(y = value, color = source)) +
  geom_boxplot() +
  theme_minimal(base_size = 14) +
    labs(title = "Average Annual Ischemic Heart Disease events averted from 2023-2073",
         subtitle = "scaled to population size 10 million aged 15+ in 2023",
         y = "Annual heart attacks averted among all adults aged 18+ (moderate/severe)") +
  scale_x_continuous(breaks = NULL) +
  theme(
      plot.title = element_text(size = 18, face = "bold"),
      axis.title.y = element_text(size = 16),
      axis.title.x = element_text(size = 16),
      
      legend.position = "bottom"
    )

df_sas %>% filter(var == "n_ihd_diff", year == "2373", sex == "All") %>% group_by(source) %>% summarize("Mean annual number of moderate/severe heart attacks deaths averted (standardized to population of 10 million adults)"= round(mean(value),2), "5%" = round(quantile(value,0.05),2), Q1 = round(quantile(value,0.25),2), median = round(median(value),2), Q3 = round(quantile(value, 0.75),2), "95%" = round(quantile(value, 0.95),2)) %>% kable(booktabs = T, align = "lcccccc") %>% kable_styling(font_size = 12, bootstrap_options = c("striped", "hover", "condensed"), position = "center", full_width = FALSE)

```

#### Incident Stroke (moderate/severe events only)
```{r}
df_sas %>% filter(var == "rate_cva_modsev", year == "2373", sex == "Male", age != "All") %>% 
  ggplot(aes(x = age, y = value, color = source)) +
  geom_boxplot() +
  theme_minimal(base_size = 14) +
    labs(title = "Average Annual Incidence of Stroke per 100 person-years from 2023-2073",
         subtitle = "Men",
         y = "Incident stroke per 100 person-years", x = "Age") +
    theme(
      plot.title = element_text(size = 18, face = "bold"),
      axis.title.y = element_text(size = 16),
      axis.title.x = element_text(size = 16),
      legend.position = "bottom"
    )

df_sas %>% filter(var == "rate_cva_modsev", year == "2373", sex == "Female", age != "All") %>% 
  ggplot(aes(x = age, y = value, color = source)) +
  geom_boxplot() +
  theme_minimal(base_size = 14) +
    labs(title = "Average Annual Incidence of Stroke per 100 person-years from 2023-2073",
         subtitle = "Women",
         y = "Incident stroke per 100 person-years", x = "Age") +
    theme(
      plot.title = element_text(size = 18, face = "bold"),
      axis.title.y = element_text(size = 16),
      axis.title.x = element_text(size = 16),
      legend.position = "bottom"
    )

df_sas %>% filter(var == "n_cva_diff", year == "2373") %>% 
  ggplot(aes(y = value, color = source)) +
  geom_boxplot() +
  theme_minimal(base_size = 14) +
    labs(title = "Average annual stroke events averted from 2023-2073",
         subtitle = "scaled to population size 10 million aged 15+ in 2023",
         y = "Annual strokes averted among all adults aged 18+ (moderate/severe)") +
  scale_x_continuous(breaks = NULL) +
  theme(
      plot.title = element_text(size = 18, face = "bold"),
      axis.title.y = element_text(size = 16),
      axis.title.x = element_text(size = 16),
      
      legend.position = "bottom"
    )

df_sas %>% filter(var == "n_cva_diff", year == "2373", sex == "All") %>% group_by(source) %>% summarize("Mean annual number of moderate/severe strokes averted (standardized to population of 10 million adults)"= round(mean(value),2), "5%" = round(quantile(value,0.05),2), Q1 = round(quantile(value,0.25),2), median = round(median(value),2), Q3 = round(quantile(value, 0.75),2), "95%" = round(quantile(value, 0.95),2)) %>% kable(booktabs = T, align = "lcccccc") %>% kable_styling(font_size = 12, bootstrap_options = c("striped", "hover", "condensed"), position = "center", full_width = FALSE)
```

## CVD Mortality

```{r graph_mortality}

df_sas %>% filter(var == "n_dead_cvd", year == "2373", sex == "All", age == "All") %>%
  ggplot(aes(y = value, color = source)) +
    geom_boxplot() +
    theme_minimal(base_size = 14) +
    coord_cartesian(ylim = c(0,NA)) +
    labs( y = "Number of CVD deaths", title = "Average number of CVD deaths per year from 2023 to 2073", subtitle = "Standardized to population size = 10,000,000") +
    theme(
      plot.title = element_text(size = 20, face = "bold"),
      axis.title.y = element_text(size = 16),
      axis.title.x = element_text(size = 16),
      legend.position = "bottom"
    )

df_sas %>% filter(var == "n_dead_cvd_diff", year == "2373") %>% 
  ggplot(aes(y = value, color = source)) +
  geom_boxplot() +
  theme_minimal(base_size = 14) +
    labs(title = "Average annual CVD deaths averted from 2023-2073",
         subtitle = "scaled to population size 10 million aged 15+ in 2023",
         y = "Annual CVD deaths averted among all adults aged 18+") +
  scale_x_continuous(breaks = NULL) +
  theme(
      plot.title = element_text(size = 18, face = "bold"),
      axis.title.y = element_text(size = 16),
      axis.title.x = element_text(size = 16),
      
      legend.position = "bottom"
    )

df_sas %>% filter(var == "n_dead_cvd", year == "2373", sex == "All") %>% group_by(source) %>% summarize("Mean annual number of CVD deaths (standardized to population of 10 million adults)"= round(mean(value),2), "5%" = round(quantile(value,0.05),2), Q1 = round(quantile(value,0.25),2), median = round(median(value),2), Q3 = round(quantile(value, 0.75),2), "95%" = round(quantile(value, 0.95),2)) %>% kable(booktabs = T, align = "lcccccc") %>% kable_styling(font_size = 12, bootstrap_options = c("striped", "hover", "condensed"), position = "center", full_width = FALSE)

df_sas %>% filter(var == "n_dead_cvd_diff", year == "2373", sex == "All") %>% group_by(source) %>% summarize("Mean annual number of CVD deaths averted (standardized to population of 10 million adults)"= round(mean(value),2), "5%" = round(quantile(value,0.05),2), Q1 = round(quantile(value,0.25),2), median = round(median(value),2), Q3 = round(quantile(value, 0.75),2), "95%" = round(quantile(value, 0.95),2)) %>% kable(booktabs = T, align = "lcccccc") %>% kable_styling(font_size = 12, bootstrap_options = c("striped", "hover", "condensed"), position = "center", full_width = FALSE)

df_sas %>% filter(var == "rate_dead_cvd", year == "2373", sex == "All") %>%
  ggplot(aes(age, value, color=source)) +
    geom_boxplot() +
    theme_minimal(base_size = 14) +
    labs(title = "Average CVD mortality rate (2023 to 2073)",
         y = "CVD mortality per 100 person-years") +
    coord_cartesian(ylim = c(0,NA)) +
    theme(
      plot.title = element_text(size = 18, face = "bold"),
      axis.title.y = element_text(size = 16),
      axis.title.x = element_text(size = 16),
      legend.position = "bottom"
    )

df_sas %>% filter(var == "rate_dead_cvd", year == "2373", sex == "All") %>% group_by(source) %>% summarize("Mean annual CVD mortality rate"= round(mean(value),2), min = round(min(value),2), Q1 = round(quantile(value,0.25),2), median = round(median(value),2), Q3 = round(quantile(value, 0.75),2), max = round(max(value),2)) %>% kable(booktabs = T, align = "lcccccc") %>% kable_styling(font_size = 12, bootstrap_options = c("striped", "hover", "condensed"), position = "center", full_width = FALSE)


df_sas %>% filter(var == "rate_dead_hivneg_cvd", year == "2373", sex == "All", age == "All") %>%
  ggplot(aes(y = value, color=source)) +
    geom_boxplot() +
    theme_minimal(base_size = 14) +
    coord_cartesian(ylim = c(0,NA)) +
    labs(title = "Average CVD mortality rate among HIV negative persons (2023 to 2073)",
         y = "CVD mortality rate per 100 person-years") +
    theme(
      plot.title = element_text(size = 18, face = "bold"),
      axis.title.y = element_text(size = 16),
      axis.title.x = element_text(size = 16),
      legend.position = "bottom"
    )

df_sas %>% filter(var == "rate_dead_hivneg_cvd", year == "2373", sex == "All") %>% group_by(source) %>% summarize("Mean CVD mortality rate among HIV-neg"= round(mean(value),2), min = round(min(value),2), Q1 = round(quantile(value,0.25),2), median = round(median(value),2), Q3 = round(quantile(value, 0.75),2), max = round(max(value),2)) %>% kable(booktabs = T, align = "lcccccc") %>% kable_styling(font_size = 12, bootstrap_options = c("striped", "hover", "condensed"), position = "center", full_width = FALSE)

df_sas %>% filter(var == "rate_dead_hivpos_cvd", year == "2373", sex == "All", age == "All") %>%
  ggplot(aes(y = value, color=source)) +
    geom_boxplot() +
    theme_minimal(base_size = 14) +
    coord_cartesian(ylim = c(0,NA)) +
    labs(title = "Average CVD mortality rate among HIV positive persons (2023 to 2073)",
         y = "CVD mortality rate per 100 person-years") +
    theme(
      plot.title = element_text(size = 18, face = "bold"),
      axis.title.y = element_text(size = 16),
      axis.title.x = element_text(size = 16),
      legend.position = "bottom"
    )

df_sas %>% filter(var == "rate_dead_hivneg_anycause", year == "2373", sex == "All") %>% group_by(source) %>% summarize("Mean CVD mortality rate among HIV+"= round(mean(value),2), min = round(min(value),2), Q1 = round(quantile(value,0.25),2), median = round(median(value),2), Q3 = round(quantile(value, 0.75),2), max = round(max(value),2)) %>% kable(booktabs = T, align = "lcccccc") %>% kable_styling(font_size = 12, bootstrap_options = c("striped", "hover", "condensed"), position = "center", full_width = FALSE)

df_sas %>% filter(var == "rate_dead_hivneg_anycause", year == "2373", sex == "All", age == "All") %>%
  ggplot(aes(y = value, color=source)) +
    geom_boxplot() +
    theme_minimal(base_size = 14) +
    coord_cartesian(ylim = c(0,NA)) +
    labs(title = "Average all-cause mortality rate among HIV negative persons (2023 to 2073)",
         y = "All-cause mortality rate per 100 person-years") +
    theme(
      plot.title = element_text(size = 18, face = "bold"),
      axis.title.y = element_text(size = 16),
      axis.title.x = element_text(size = 16),
      legend.position = "bottom"
    )

df_sas %>% filter(var == "rate_dead_hivneg_anycause", year == "2373", sex == "All") %>% group_by(source) %>% summarize("Mean all-cause mortality rate among HIV-neg"= round(mean(value),2), min = round(min(value),2), Q1 = round(quantile(value,0.25),2), median = round(median(value),2), Q3 = round(quantile(value, 0.75),2), max = round(max(value),2)) %>% kable(booktabs = T, align = "lcccccc") %>% kable_styling(font_size = 12, bootstrap_options = c("striped", "hover", "condensed"), position = "center", full_width = FALSE)

df_sas %>% filter(var == "rate_dead_hivpos_anycause", year == "2373", sex == "All", age == "All") %>%
  ggplot(aes(y = value, color=source)) +
    geom_boxplot() +
    theme_minimal(base_size = 14) +
    coord_cartesian(ylim = c(0,NA)) +
    labs(title = "Average all-cause mortality rate among HIV positive persons (2023 to 2073)",
         y = "All-cause mortality rate per 100 person-years") +
    theme(
      plot.title = element_text(size = 18, face = "bold"),
      axis.title.y = element_text(size = 16),
      axis.title.x = element_text(size = 16),
      legend.position = "bottom"
    )

df_sas %>% filter(var == "rate_dead_hivpos_anycause", year == "2373", sex == "All") %>% group_by(source) %>% summarize("Mean all-cause mortality rate among HIV+"= round(mean(value),2), min = round(min(value),2), Q1 = round(quantile(value,0.25),2), median = round(median(value),2), Q3 = round(quantile(value, 0.75),2), max = round(max(value),2)) %>% kable(booktabs = T, align = "lcccccc") %>% kable_styling(font_size = 12, bootstrap_options = c("striped", "hover", "condensed"), position = "center", full_width = FALSE)

```




## Cost

Cost assumptions (in USD):

* Community health worker screening: $3/person screened (estimates from SEARCH)
* Transportation voucher: $5/person linked (Hickey 2022)
* Clinic visits: $20/visit if uncontrolled and $10/visit if controlled (Shade 2021, Shiri 2021)
* HTN medications (90-day supply) (Resolve to Save Lives 2022)
  * Med 1 & 2: $1.5
  * Med 3: $3
* Acute MI/CVA treatment (Subramanian 2019)
  * MI: $2270
  * CVA: $2420
  * cost of acute care that is not effective (poor-quality):
    * MI: $1135
    * CVA: $1210
    * we assume that some poor quality care may be due in part to limited staffing, diagnositic equipment, and medications - and therefore may also cost less. In other cases, similar interventions/diagnostic tests may be undertaken, though the effectiveness will be lower due to delays in care. We assume that such care for acute MI/CVA costs 50% of the cost of effective acute care

```{r cost}
df_sas %>% filter(year == "2373", var %in% c("dhtn_cost_scr", "dhtn_cost_clin", "dhtn_cost_drug", "dhtn_cost_cvd", "dhtn_cost_total")) %>%
    mutate(var = factor(var, 
                        levels = c("dhtn_cost_scr", "dhtn_cost_clin", "dhtn_cost_drug", "dhtn_cost_cvd", "dhtn_cost_total"),
                        labels= c("scr", "clin", "drug", "cvd", "total htn"))) %>% 
  ggplot(aes(var, value, color = source)) +
    geom_boxplot() +
    theme_minimal(base_size = 14) +
    coord_cartesian(ylim = c(0,NA)) +
    labs( y = "Cost in millions of USD (discounted)", title = "Average annual discounted HTN costs (in millions USD) from 2023 to 2073", subtitle = "Standardized to population size = 10,000,000", x = "Cost category") +
    theme(
      plot.title = element_text(size = 18, face = "bold"),
      axis.title.y = element_text(size = 16),
      axis.title.x = element_text(size = 16),
      legend.position = "bottom"
    )

  df_sas %>% filter(year == "2373", var == "dhtn_cost_total") %>% group_by(source) %>% summarize("Mean annual discounted hypertension cost from 2023-2073 (millions USD)"= round(mean(value),1), min = round(min(value),1), Q1 = round(quantile(value,0.25),1), median = round(median(value),1), Q3 = round(quantile(value, 0.75),1), max = round(max(value),1)) %>% kable(booktabs = T, align = "lcccccc") %>% kable_styling(font_size = 12, bootstrap_options = c("striped", "hover", "condensed"), position = "center", full_width = FALSE)

```


## Cost-effectiveness

### Cost-effectiveness frontier
```{r icer}

plot_icer %>% 
  filter(cost_cat %in% c("total (50% clinic cost)", "total htn", "total (200% clinic cost)")) %>% 
  ggplot(aes(x = mean_ddaly, y = mean_cost, color = cost_cat)) +
  geom_line() +
  geom_point() +
  annotate("text", x=0, y=1, label= "SOC") +
  annotate("text", x=18, y=5, label= "Chronic Care Clinic") +
  annotate("text", x=18, y=4, label= "$39/DALY", color = "#7570B3") +
  annotate("text", x=18, y=3, label= "$20/DALY", color = "#D95F02") +
  annotate("text", x=18, y=2, label= "$10/DALY", color = "#1B9E77") +
  annotate("text", x=78, y=21, label= "CHW Screening") +
  annotate("text", x=78, y=20, label= "$552/DALY", color = "#7570B3") +
  annotate("text", x=78, y=19, label= "$351/DALY", color = "#D95F02") +
  annotate("text", x=78, y=18, label= "$250/DALY", color = "#1B9E77") +
  theme_minimal(base_size = 14) +
  coord_cartesian(ylim = c(0,30), xlim = c(0,80)) +
  labs(title = "Cost-effectiveness of hypertension treatment policies (2023 - 2073)",
       subtitle = "Alternative assumptions about clinic costs",
       y = "Annual incremental cost (millions $USD)",
       x = "Annual DALYs averted (thousands)") +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    axis.title.y = element_text(size = 14),
    axis.title.x = element_text(size = 14),
    legend.position = "bottom"
  ) +
  scale_color_brewer(palette = "Dark2")

plot_icer %>% 
  filter(cost_cat %in% c("total (50% drug cost)", "total htn", "total (200% drug cost)")) %>% 
  ggplot(aes(x = mean_ddaly, y = mean_cost, color = cost_cat)) +
  geom_line() +
  geom_point() +
  annotate("text", x=0, y=1, label= "SOC") +
  annotate("text", x=18, y=7, label= "Chronic Care Clinic") +
  annotate("text", x=18, y=6, label= "$163/DALY", color = "#7570B3") +
  annotate("text", x=18, y=5, label= "$20/DALY", color = "#D95F02") +
  annotate("text", x=18, y=4, label= "$-52/DALY (cost-saving)", color = "#1B9E77") +
  annotate("text", x=78, y=21, label= "CHW Screening") +
  annotate("text", x=78, y=20, label= "$495/DALY", color = "#7570B3") +
  annotate("text", x=78, y=19, label= "$351/DALY", color = "#D95F02") +
  annotate("text", x=78, y=18, label= "$279/DALY", color = "#1B9E77") +
  theme_minimal(base_size = 14) +
  labs(title = "Cost-effectiveness of hypertension treatment policies (2023 - 2073)",
       subtitle = "Alternative assumptions about drug costs",
       y = "Annual incremental cost (millions $USD)",
       x = "Annual DALYs averted (thousands)") +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    axis.title.y = element_text(size = 14),
    axis.title.x = element_text(size = 14),
    legend.position = "bottom"
  ) +
  scale_color_brewer(palette = "Dark2")

plot_icer %>% 
  filter(cost_cat %in% c("total (50% screening cost)", "total htn", "total (200% screening cost)")) %>% 
  ggplot(aes(x = mean_ddaly, y = mean_cost, color = cost_cat)) +
  geom_line() +
  geom_point() +
  annotate("text", x=0, y=1, label= "SOC") +
  annotate("text", x=20, y=3, label= "Chronic Care Clinic") +
  annotate("text", x=20, y=2, label= "$20/DALY", color = "#D95F02") +
  annotate("text", x=78, y=21, label= "CHW Screening") +
  annotate("text", x=78, y=20, label= "$480/DALY", color = "#7570B3") +
  annotate("text", x=78, y=19, label= "$351/DALY", color = "#D95F02") +
  annotate("text", x=78, y=18, label= "$287/DALY", color = "#1B9E77") +
  theme_minimal(base_size = 14) +
  labs(title = "Cost-effectiveness of hypertension treatment policies (2023 - 2073)",
       subtitle = "Alternative assumptions about screening costs",
       y = "Annual incremental cost (millions $USD)",
       x = "Annual DALYs averted (thousands)") +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    axis.title.y = element_text(size = 14),
    axis.title.x = element_text(size = 14),
    legend.position = "bottom"
  ) +
  scale_color_brewer(palette = "Dark2")



```



